{"ID":"20230817161958-sbeo4py","Spec":"1","Type":"NodeDocument","Properties":{"id":"20230817161958-sbeo4py","title":"共享变量","updated":"20230817161958"},"Children":[{"ID":"20230817161959-0i1527h","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20230817161959-0i1527h","updated":"20230817161959"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"# ","Properties":{"id":""}},{"Type":"NodeText","Data":"共享变量"}]},{"ID":"20230817161960-wpeizxp","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230817161960-wpeizxp","updated":"20230817161960"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"共享变量的工作原理"}]},{"ID":"20230817161961-1o3cigv","Type":"NodeParagraph","Properties":{"id":"20230817161961-1o3cigv","updated":"20230817161961"},"Children":[{"Type":"NodeText","Data":"Spark还有一个非常重要的特性就是共享变量"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"默认情况下，如果在一个算子函数中使用到了某个外部的变量，那么这个变量的值会被拷贝到每个task中。此时每个task只能操作自己的那份变量数据。如果多个task想要共享某个变量，那么这种方式是做不到的。"}]},{"ID":"20230817161962-yo5n5fa","Type":"NodeParagraph","Properties":{"id":"20230817161962-yo5n5fa","updated":"20230817161962"},"Children":[{"Type":"NodeText","Data":"Spark为此提供了两种共享变量"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"一种是Broadcast Variable（广播变量）"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"另一种是Accumulator（累加变量）"}]},{"ID":"20230817161963-by36una","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230817161963-by36una","updated":"20230817161963"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"Broadcast Variable"}]},{"ID":"20230817161964-2cal7ip","Type":"NodeParagraph","Properties":{"id":"20230817161964-2cal7ip","updated":"20230817161964"},"Children":[{"Type":"NodeText","Data":"Broadcast Variable会将使用到的变量，仅仅为每个节点拷贝一份，而不会为每个task都拷贝一份副本，因此其最大的作用，就是减少变量到各个节点的网络传输消耗，以及在各个节点上的内存消耗"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"通过调用SparkContext的broadcast()方法，针对某个变量创建广播变量"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"注意：广播变量，是只读的"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"然后在算子函数内，使用到广播变量时，每个节点只会拷贝一份副本。可以使用广播变量的value()方法获取值。"}]},{"ID":"20230817161965-h3mfmav","Type":"NodeParagraph","Properties":{"id":"20230817161965-h3mfmav","updated":"20230817161965"},"Children":[{"Type":"NodeText","Data":"接下来看一个图深入理解一下"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"图片描述","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://img.mukewang.com/wiki/5f51e2ac094aa33312650604.jpg","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20230817161966-t557cum","Type":"NodeParagraph","Properties":{"id":"20230817161966-t557cum","updated":"20230817161966"},"Children":[{"Type":"NodeText","Data":"先看左边的代码"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"这个是一个咱们经常使用的map算子的代码，map算子中执行对每一个元素乘以一个固定变量的操作，此时这个固定的变量属于外部变量。"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"默认情况下，算子函数内，使用到的外部变量，会被拷贝到执行这个算子的每一个task中"}]},{"ID":"20230817161967-t1mog45","Type":"NodeParagraph","Properties":{"id":"20230817161967-t1mog45","updated":"20230817161967"},"Children":[{"Type":"NodeText","Data":"看图中间的MapTask，这些都是map算子产生的task，也就是说这个外部变量会被拷贝到每一个task中。"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"如果这个外部变量是一个集合，集合中有上亿条数据，这个网络传输就会很耗时，而且在每个task上，占用的内存空间，也会很大"}]},{"ID":"20230817161968-za6f0ii","Type":"NodeParagraph","Properties":{"id":"20230817161968-za6f0ii","updated":"20230817161968"},"Children":[{"Type":"NodeText","Data":"如果算子函数中使用的外部变量，是广播变量的话，那么每个变量只会拷贝一份到每个节点上。节点上所有的task都会共享这一份变量，就可以减少网络传输消耗的时间，以及减少内存占用了。"}]},{"ID":"20230817161969-irxgniz","Type":"NodeParagraph","Properties":{"id":"20230817161969-irxgniz","updated":"20230817161969"},"Children":[{"Type":"NodeText","Data":"大家可以想象一个极端情况，如果map算子有10个task，恰好这10个task还都在一个worker节点上，那么这个时候，map算子使用的外部变量就会在这个worker节点上保存10份，这样就很占用内存了。"}]}]}