{"ID":"20230817161846-grfzbpd","Spec":"1","Type":"NodeDocument","Properties":{"id":"20230817161846-grfzbpd","title":"Spark Shuffle概念及shuffle机制","updated":"20230817161846"},"Children":[{"ID":"20230817161847-qi8kpz0","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230817161847-qi8kpz0","updated":"20230817161847"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"Spark Shuffle概念及shuffle机制"}]},{"ID":"20230817161848-peq0w6w","Type":"NodeParagraph","Properties":{"id":"20230817161848-peq0w6w","updated":"20230817161848"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"1.前言："}]},{"ID":"20230817161849-g0bamwh","Type":"NodeParagraph","Properties":{"id":"20230817161849-g0bamwh","updated":"20230817161849"},"Children":[{"Type":"NodeText","Data":"在理解Saprk Shuffle的过程前，我们先回顾下MapReduce的Shuffle过程："}]},{"ID":"20230817161850-1148flr","Type":"NodeParagraph","Properties":{"id":"20230817161850-1148flr","updated":"20230817161850"},"Children":[{"Type":"NodeText","Data":"在MapReduce框架中，Shuffle是连接Map和Reduce之间的桥梁，Map阶段的数据通过shuffle输出到对应的Reduce中，然后Reduce对数据执行计算。"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"在整个shuffle过程中，往往伴随这大量的磁盘和网络I/O，所以shuffle性能的高低也直接决定了整个程序的性能高低。"}]},{"ID":"20230817161851-mr67wnj","Type":"NodeParagraph","Properties":{"id":"20230817161851-mr67wnj","updated":"20230817161851"},"Children":[{"Type":"NodeText","Data":"下面是 MapReduce 的 shuffle 过程，数据被拉取到不同的节点上进行聚合处理，会产生大量的磁盘和网络IO。"}]},{"ID":"20230817161852-dr5sg2t","Type":"NodeParagraph","Properties":{"id":"20230817161852-dr5sg2t","updated":"20230817161852"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"img","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://pic4.zhimg.com/80/v2-7922486f9a5b271abe91e63f17cf3ca3_720w.jpg","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20230817161853-gbws0sl","Type":"NodeParagraph","Properties":{"id":"20230817161853-gbws0sl","updated":"20230817161853"},"Children":[{"Type":"NodeText","Data":"Spark 也有自己的 shuffle 过程。下图是 DAG schedula的任务划分，从最后一个RDD往前追溯，遇到宽依赖（shuffle）就划分一个 Stage。"}]},{"ID":"20230817161854-9l2dbox","Type":"NodeParagraph","Properties":{"id":"20230817161854-9l2dbox","updated":"20230817161854"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"img","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://pic2.zhimg.com/80/v2-92a6e538e69e3ef92aca7278288ff541_720w.jpg","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20230817161855-x1znrwj","Type":"NodeParagraph","Properties":{"id":"20230817161855-x1znrwj","updated":"20230817161855"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"2.相关概念："}]},{"ID":"20230817161856-wuxfajn","Type":"NodeParagraph","Properties":{"id":"20230817161856-wuxfajn","updated":"20230817161856"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"MapOutPutTracker"},{"Type":"NodeText","Data":"：MapOutPutTracker是Saprk里面的一个模块，主从架构，用来管理磁盘中的小文件的地址。"}]},{"ID":"20230817161857-c13aus4","Type":"NodeParagraph","Properties":{"id":"20230817161857-c13aus4","updated":"20230817161857"},"Children":[{"Type":"NodeText","Data":"包含："}]},{"ID":"20230817161858-c5ukjof","Type":"NodeParagraph","Properties":{"id":"20230817161858-c5ukjof","updated":"20230817161858"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"MapOutPutTrackerMaster"},{"Type":"NodeText","Data":"：主节点，存在于Driver中"}]},{"ID":"20230817161859-hxaoor2","Type":"NodeParagraph","Properties":{"id":"20230817161859-hxaoor2","updated":"20230817161859"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"MapOutPutTrackerWorker"},{"Type":"NodeText","Data":"：从节点，存在于Executor中"}]},{"ID":"20230817161860-e0vvase","Type":"NodeParagraph","Properties":{"id":"20230817161860-e0vvase","updated":"20230817161860"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"BlockManager："},{"Type":"NodeText","Data":"块管理，也是spark中的一个模块，主从架构"}]},{"ID":"20230817161861-6kwflqb","Type":"NodeParagraph","Properties":{"id":"20230817161861-6kwflqb","updated":"20230817161861"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"BlockManagerMaster"},{"Type":"NodeText","Data":"：主节点，存在于Driver中，用于在集群中，传递广播变量或缓存数据，或者删除数据时通知其他的跟随节点来进行相应的操作。"}]},{"ID":"20230817161862-9epw64i","Type":"NodeParagraph","Properties":{"id":"20230817161862-9epw64i","updated":"20230817161862"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"BlockManagerWorker"},{"Type":"NodeText","Data":"：从节点，存在于Executor 中。会与BlockManagerMaster节点进行通信"}]},{"ID":"20230817161863-8niuum1","Type":"NodeParagraph","Properties":{"id":"20230817161863-8niuum1","updated":"20230817161863"},"Children":[{"Type":"NodeText","Data":"无论是在Driver端的BlockManager还是在Executor端的BlockManager都含有四个对象："}]},{"ID":"20230817161864-72yfo4k","Type":"NodeParagraph","Properties":{"id":"20230817161864-72yfo4k","updated":"20230817161864"},"Children":[{"Type":"NodeText","Data":"DiskStore：负责磁盘的管理"}]},{"ID":"20230817161865-ozlwvlm","Type":"NodeParagraph","Properties":{"id":"20230817161865-ozlwvlm","updated":"20230817161865"},"Children":[{"Type":"NodeText","Data":"MemoryStore：负责内存的管理"}]},{"ID":"20230817161866-9bjhbf5","Type":"NodeParagraph","Properties":{"id":"20230817161866-9bjhbf5","updated":"20230817161866"},"Children":[{"Type":"NodeText","Data":"ConnectionManager：负责连接其他的BlockManagerWorker"}]},{"ID":"20230817161867-gidwvay","Type":"NodeParagraph","Properties":{"id":"20230817161867-gidwvay","updated":"20230817161867"},"Children":[{"Type":"NodeText","Data":"BlockTransferService：负责数据的传输"}]},{"ID":"20230817161868-15h52c0","Type":"NodeParagraph","Properties":{"id":"20230817161868-15h52c0","updated":"20230817161868"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"3.什么是Spark Shuffle？"}]},{"ID":"20230817161869-yk5cu4g","Type":"NodeParagraph","Properties":{"id":"20230817161869-yk5cu4g","updated":"20230817161869"},"Children":[{"Type":"NodeText","Data":"reduceByKey会将一个RDD中的每一个key对应的所有value聚合成一个value，然后生成一个新的RDD，元素类型是\u003ckey,value\u003e对的形式，这样每一个key对应一个聚合起来的value。"}]},{"ID":"20230817161870-bhhdi00","Type":"NodeParagraph","Properties":{"id":"20230817161870-bhhdi00","updated":"20230817161870"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"问题："}]},{"ID":"20230817161871-9fw2qyb","Type":"NodeParagraph","Properties":{"id":"20230817161871-9fw2qyb","updated":"20230817161871"},"Children":[{"Type":"NodeText","Data":"每一个key对应的value不一定都是在一个partition中，也不太可能在同一个节点上，因为RDD是分布式的弹性的数据集，它的partition极有可能分布在各个节点上。"}]},{"ID":"20230817161872-cz3gd93","Type":"NodeParagraph","Properties":{"id":"20230817161872-cz3gd93","updated":"20230817161872"},"Children":[{"Type":"NodeText","Data":"聚合形式："}]},{"ID":"20230817161873-b1weyg0","Type":"NodeParagraph","Properties":{"id":"20230817161873-b1weyg0","updated":"20230817161873"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"如何聚合："}]},{"ID":"20230817161874-2jblkkp","Type":"NodeParagraph","Properties":{"id":"20230817161874-2jblkkp","updated":"20230817161874"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Shuffle Write："},{"Type":"NodeText","Data":"上一个stage的每一个map task就必须保证将自己处理的当前分区中的数据相同的key写入一个分区文件中，可能会写入多个不同的分区文件中。"}]},{"ID":"20230817161875-rni7n9c","Type":"NodeParagraph","Properties":{"id":"20230817161875-rni7n9c","updated":"20230817161875"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Shuffle Read："},{"Type":"NodeText","Data":"reduce task就会从上一个stage的所有task所在的机器上寻找属于自己的那些分区文件，这样就可以保证每一个key所对应的value都会汇聚在同一个节点上去处理和聚合。"}]},{"ID":"20230817161876-4bbvzf2","Type":"NodeParagraph","Properties":{"id":"20230817161876-4bbvzf2","updated":"20230817161876"},"Children":[{"Type":"NodeText","Data":"Spark中有两种Shuffle管理类型，HashShuffleManager和SortShuffleManager，Spark1.2之前是HashShuffleManager，Spark1.2引入SortShuffleManager，在Spark2.0+版本中已经将HashShuffleManager丢弃。"}]},{"ID":"20230817161877-lczch74","Type":"NodeParagraph","Properties":{"id":"20230817161877-lczch74","updated":"20230817161877"},"Children":[{"Type":"NodeText","Data":"HashShuffleManager:"}]},{"ID":"20230817161878-iklcjpu","Type":"NodeParagraph","Properties":{"id":"20230817161878-iklcjpu","updated":"20230817161878"},"Children":[{"Type":"NodeText","Data":"1).普通机制：M（map task的个数）*R（reduce task的个数）"}]},{"ID":"20230817161879-irxzgrp","Type":"NodeParagraph","Properties":{"id":"20230817161879-irxzgrp","updated":"20230817161879"},"Children":[{"Type":"NodeText","Data":"2).优化机制：C（core的个数）*R（Reduce的个数）"}]},{"ID":"20230817161880-owzugvr","Type":"NodeParagraph","Properties":{"id":"20230817161880-owzugvr","updated":"20230817161880"},"Children":[{"Type":"NodeText","Data":"SortShuffleManager:"}]},{"ID":"20230817161881-8htjjot","Type":"NodeParagraph","Properties":{"id":"20230817161881-8htjjot","updated":"20230817161881"},"Children":[{"Type":"NodeText","Data":"1).普通机制:2*M"}]},{"ID":"20230817161882-764utof","Type":"NodeParagraph","Properties":{"id":"20230817161882-764utof","updated":"20230817161882"},"Children":[{"Type":"NodeText","Data":"2).bypass机制，没有排序：2*M"}]},{"ID":"20230817161883-chw4krz","Type":"NodeParagraph","Properties":{"id":"20230817161883-chw4krz","updated":"20230817161883"},"Children":[{"Type":"NodeText","Data":"图解Hash-Based Shuffle"}]},{"ID":"20230817161884-c1ie6o6","Type":"NodeParagraph","Properties":{"id":"20230817161884-c1ie6o6","updated":"20230817161884"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"img","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://pic4.zhimg.com/80/v2-3df91c4fe532412365344cb618c18fa7_720w.jpg","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20230817161885-xmofk16","Type":"NodeParagraph","Properties":{"id":"20230817161885-xmofk16","updated":"20230817161885"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"但是Shuffle可能面临的问题的是："}]},{"ID":"20230817161886-h60j5fc","Type":"NodeParagraph","Properties":{"id":"20230817161886-h60j5fc","updated":"20230817161886"},"Children":[{"Type":"NodeText","Data":"1.小文件过多，耗时低效的IO操作"}]},{"ID":"20230817161887-f9t645k","Type":"NodeParagraph","Properties":{"id":"20230817161887-f9t645k","updated":"20230817161887"},"Children":[{"Type":"NodeText","Data":"2.OOM，读写文件以及缓存过多"}]},{"ID":"20230817161888-c5x7ml1","Type":"NodeParagraph","Properties":{"id":"20230817161888-c5x7ml1","updated":"20230817161888"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"img","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://pic4.zhimg.com/80/v2-b1f49fe4cba934442f3f095013e8c9df_720w.jpg","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20230817161889-ynpqzvh","Type":"NodeParagraph","Properties":{"id":"20230817161889-ynpqzvh","updated":"20230817161889"},"Children":[{"Type":"NodeText","Data":"执行流程:"}]},{"ID":"20230817161890-xv1k2bs","Type":"NodeParagraph","Properties":{"id":"20230817161890-xv1k2bs","updated":"20230817161890"},"Children":[{"Type":"NodeText","Data":"（a）每一个Map task会将结果写入到不同的buffer中，每个buffer的大小为32k，buffer起到数据缓存的作用。"}]},{"ID":"20230817161891-ocnewdf","Type":"NodeParagraph","Properties":{"id":"20230817161891-ocnewdf","updated":"20230817161891"},"Children":[{"Type":"NodeText","Data":"（b）每个buffer文件最后对应一个磁盘小文件"}]},{"ID":"20230817161892-wqh5o5l","Type":"NodeParagraph","Properties":{"id":"20230817161892-wqh5o5l","updated":"20230817161892"},"Children":[{"Type":"NodeText","Data":"（c）reduce task来拉取对应的磁盘小文件"}]},{"ID":"20230817161893-0bim7lz","Type":"NodeParagraph","Properties":{"id":"20230817161893-0bim7lz","updated":"20230817161893"},"Children":[{"Type":"NodeText","Data":"总结："}]},{"ID":"20230817161894-bi90q8o","Type":"NodeParagraph","Properties":{"id":"20230817161894-bi90q8o","updated":"20230817161894"},"Children":[{"Type":"NodeText","Data":"（1）map task的计算结果会根据分区器（默认hashPartitioner）来决定写入到哪一个磁盘小文件中去。ReduceTask会去Map端拉取相应的磁盘小文件。"}]},{"ID":"20230817161895-q88gidl","Type":"NodeParagraph","Properties":{"id":"20230817161895-q88gidl","updated":"20230817161895"},"Children":[{"Type":"NodeText","Data":"（2）产生的磁盘小文件的个数："}]},{"ID":"20230817161896-32g5e79","Type":"NodeParagraph","Properties":{"id":"20230817161896-32g5e79","updated":"20230817161896"},"Children":[{"Type":"NodeText","Data":"M（map task的个数）*R（reduce task的个数）"}]},{"ID":"20230817161897-vonqtig","Type":"NodeParagraph","Properties":{"id":"20230817161897-vonqtig","updated":"20230817161897"},"Children":[{"Type":"NodeText","Data":"存在的问题："}]},{"ID":"20230817161898-yalsidg","Type":"NodeParagraph","Properties":{"id":"20230817161898-yalsidg","updated":"20230817161898"},"Children":[{"Type":"NodeText","Data":"产生的磁盘小文件过多，会导致以下问题："}]},{"ID":"20230817161899-tf19jwr","Type":"NodeParagraph","Properties":{"id":"20230817161899-tf19jwr","updated":"20230817161899"},"Children":[{"Type":"NodeText","Data":"（a）在shuffle Write过程中会产生很多写磁盘小文件的对象"}]},{"ID":"20230817161900-jm64pen","Type":"NodeParagraph","Properties":{"id":"20230817161900-jm64pen","updated":"20230817161900"},"Children":[{"Type":"NodeText","Data":"（b）在shuffle read过程中会产生很多读取磁盘小文件的对象"}]},{"ID":"20230817161901-j7tbh5g","Type":"NodeParagraph","Properties":{"id":"20230817161901-j7tbh5g","updated":"20230817161901"},"Children":[{"Type":"NodeText","Data":"（c）在JVM堆内存中对象过多回来造成频繁的gc，gc还无法解决运行所需要的内存的话，就会OOM"}]},{"ID":"20230817161902-ydiqvzd","Type":"NodeParagraph","Properties":{"id":"20230817161902-ydiqvzd","updated":"20230817161902"},"Children":[{"Type":"NodeText","Data":"（d）在数据传输过程中会有频繁的网络通信，频繁的网络通信出现通信故障的可能性大大增加，一旦网络通信出现了故障会导致shuffle file cannot find 由于这个错误导致的task失败，TaskScheduler不负责重试，由DAGScheduler负责重试Stage。"}]},{"ID":"20230817161903-yk1z326","Type":"NodeParagraph","Properties":{"id":"20230817161903-yk1z326","updated":"20230817161903"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"合并机制："}]},{"ID":"20230817161904-2tj3upt","Type":"NodeParagraph","Properties":{"id":"20230817161904-2tj3upt","updated":"20230817161904"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"HashShuffleManager原理："}]},{"ID":"20230817161905-ex2avcq","Type":"NodeParagraph","Properties":{"id":"20230817161905-ex2avcq","updated":"20230817161905"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"img","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://pic2.zhimg.com/80/v2-0f67252fbe35d4ed3fe18126c58cb4b1_720w.jpg","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20230817161906-1e8bf0m","Type":"NodeParagraph","Properties":{"id":"20230817161906-1e8bf0m","updated":"20230817161906"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"总结："}]},{"ID":"20230817161907-tmfg19k","Type":"NodeParagraph","Properties":{"id":"20230817161907-tmfg19k","updated":"20230817161907"},"Children":[{"Type":"NodeText","Data":"产生磁盘小文件的个数：C（core的个数）*R（reduce的个数）"}]},{"ID":"20230817161908-os6obo5","Type":"NodeParagraph","Properties":{"id":"20230817161908-os6obo5","updated":"20230817161908"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"SortShuffle运行原理："}]},{"ID":"20230817161909-k5toj44","Type":"NodeParagraph","Properties":{"id":"20230817161909-k5toj44","updated":"20230817161909"},"Children":[{"Type":"NodeText","Data":"SortShuffle的运行机制主要分成两种："}]},{"ID":"20230817161910-uw1rswq","Type":"NodeParagraph","Properties":{"id":"20230817161910-uw1rswq","updated":"20230817161910"},"Children":[{"Type":"NodeText","Data":"普通运行机制"}]},{"ID":"20230817161911-oalq0he","Type":"NodeParagraph","Properties":{"id":"20230817161911-oalq0he","updated":"20230817161911"},"Children":[{"Type":"NodeText","Data":"bypass运行机制"}]},{"ID":"20230817161912-fmkfxvs","Type":"NodeParagraph","Properties":{"id":"20230817161912-fmkfxvs","updated":"20230817161912"},"Children":[{"Type":"NodeText","Data":"SortShuffle两种运行机制的区别："}]},{"ID":"20230817161913-roy9366","Type":"NodeParagraph","Properties":{"id":"20230817161913-roy9366","updated":"20230817161913"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"SortShuffleManager普通运行机制："}]},{"ID":"20230817161914-9t3hlol","Type":"NodeParagraph","Properties":{"id":"20230817161914-9t3hlol","updated":"20230817161914"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"img","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://pic2.zhimg.com/80/v2-bde620f1abf563687059d7d00bc66f65_720w.jpg","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20230817161915-gzqkfuu","Type":"NodeParagraph","Properties":{"id":"20230817161915-gzqkfuu","updated":"20230817161915"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"执行流程："}]},{"ID":"20230817161916-g13g8kw","Type":"NodeParagraph","Properties":{"id":"20230817161916-g13g8kw","updated":"20230817161916"},"Children":[{"Type":"NodeText","Data":"a) map task 的计算结果会写入到一个内存数据结构里面，内存数据结构默认是5M"}]},{"ID":"20230817161917-jjxwbx1","Type":"NodeParagraph","Properties":{"id":"20230817161917-jjxwbx1","updated":"20230817161917"},"Children":[{"Type":"NodeText","Data":"b) 在shuffle的时候会有一个定时器，不定期的去估算这个内存结构的大小，当内存结构中的数据超过5M时，比如现在内存结构中的数据为5.01M，那么他会申请5.01*2-5=5.02M内存给内存数据结构。"}]},{"ID":"20230817161918-whtkmid","Type":"NodeParagraph","Properties":{"id":"20230817161918-whtkmid","updated":"20230817161918"},"Children":[{"Type":"NodeText","Data":"c) 如果申请成功不会进行溢写，如果申请不成功，这时候会发生溢写磁盘。"}]},{"ID":"20230817161919-azjgvf7","Type":"NodeParagraph","Properties":{"id":"20230817161919-azjgvf7","updated":"20230817161919"},"Children":[{"Type":"NodeText","Data":"d) 在溢写之前内存结构中的数据会进行排序分区"}]},{"ID":"20230817161920-qpt0vqo","Type":"NodeParagraph","Properties":{"id":"20230817161920-qpt0vqo","updated":"20230817161920"},"Children":[{"Type":"NodeText","Data":"e) 然后开始溢写磁盘，写磁盘是以batch的形式去写，一个batch是1万条数据，"}]},{"ID":"20230817161921-n4w689a","Type":"NodeParagraph","Properties":{"id":"20230817161921-n4w689a","updated":"20230817161921"},"Children":[{"Type":"NodeText","Data":"f) map task执行完成后，会将这些磁盘小文件合并成一个大的磁盘文件，同时生成一个索引文件。"}]},{"ID":"20230817161922-vaehx80","Type":"NodeParagraph","Properties":{"id":"20230817161922-vaehx80","updated":"20230817161922"},"Children":[{"Type":"NodeText","Data":"g) reduce task去map端拉取数据的时候，首先解析索引文件，根据索引文件再去拉取对应的数据。"}]},{"ID":"20230817161923-1uyi0y0","Type":"NodeParagraph","Properties":{"id":"20230817161923-1uyi0y0","updated":"20230817161923"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"总结："}]},{"ID":"20230817161924-ftilb8s","Type":"NodeParagraph","Properties":{"id":"20230817161924-ftilb8s","updated":"20230817161924"},"Children":[{"Type":"NodeText","Data":"产生磁盘小文件的个数：2"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"em","TextMarkTextContent":"M（map task的个数）因为每个maptask要产生一个磁盘文件 和一个索引文件 所以这里是2"},{"Type":"NodeText","Data":"M"}]},{"ID":"20230817161925-aw900ki","Type":"NodeParagraph","Properties":{"id":"20230817161925-aw900ki","updated":"20230817161925"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"byPass运行机制"}]},{"ID":"20230817161926-6zrrjux","Type":"NodeParagraph","Properties":{"id":"20230817161926-6zrrjux","updated":"20230817161926"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"img","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://pic4.zhimg.com/80/v2-a6e99eb103b1a890612898359b03220b_720w.jpg","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20230817161927-gs2m4ff","Type":"NodeParagraph","Properties":{"id":"20230817161927-gs2m4ff","updated":"20230817161927"},"Children":[{"Type":"NodeText","Data":"bypass运行机制的触发条件如下："}]},{"ID":"20230817161928-clndl1o","Type":"NodeParagraph","Properties":{"id":"20230817161928-clndl1o","updated":"20230817161928"},"Children":[{"Type":"NodeText","Data":"（1）shuffle reduce task数量小于spark.shuffle.sort.bypassMergeThreshold的参数值（默认是200）"}]},{"ID":"20230817161929-yrr1j4z","Type":"NodeParagraph","Properties":{"id":"20230817161929-yrr1j4z","updated":"20230817161929"},"Children":[{"Type":"NodeText","Data":"（2）产生的磁盘的小文件为：2*M（map task的个数）"}]}]}