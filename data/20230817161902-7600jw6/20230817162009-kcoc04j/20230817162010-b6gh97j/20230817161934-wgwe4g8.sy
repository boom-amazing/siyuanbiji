{"ID":"20230817161934-wgwe4g8","Spec":"1","Type":"NodeDocument","Properties":{"id":"20230817161934-wgwe4g8","title":"拉链表","updated":"20230817161934"},"Children":[{"ID":"20230817161935-hicmag3","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20230817161935-hicmag3","updated":"20230817161935"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"拉链表"}]},{"ID":"20230817161936-14yxagd","Type":"NodeHeading","HeadingLevel":5,"Properties":{"id":"20230817161936-14yxagd","updated":"20230817161936"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"##### ","Properties":{"id":""}},{"Type":"NodeText","Data":"拉链表的使用场景"}]},{"ID":"20230817161937-yz9rkoj","Type":"NodeParagraph","Properties":{"id":"20230817161937-yz9rkoj","updated":"20230817161937"},"Children":[{"Type":"NodeText","Data":"在数据仓库的数据模型设计过程中，经常会遇到下面这种表的设计："}]},{"ID":"20230817161938-12zm5kv","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20230817161938-12zm5kv","updated":"20230817161938"},"Children":[{"ID":"20230817161939-sl7kq7g","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20230817161939-sl7kq7g","updated":"20230817161939"},"Children":[{"ID":"20230817161940-whzqlm2","Type":"NodeParagraph","Properties":{"id":"20230817161940-whzqlm2","updated":"20230817161940"},"Children":[{"Type":"NodeText","Data":"有一些表的数据量很大，比如一张用户表，大约 10 亿条记录，50 个字段，这种表，即使使用 Orc 压缩，单张表的存储也会超过 100G，在 Hdfs 使用双备份或者三备份的话就更大一些。"}]}]},{"ID":"20230817161941-g9wxs4g","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20230817161941-g9wxs4g","updated":"20230817161941"},"Children":[{"ID":"20230817161942-nqey8hj","Type":"NodeParagraph","Properties":{"id":"20230817161942-nqey8hj","updated":"20230817161942"},"Children":[{"Type":"NodeText","Data":"表中的部分字段会被 Update 更新操作，如用户联系方式，产品的描述信息，订单的状态等等。"}]}]},{"ID":"20230817161943-eyv3edz","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20230817161943-eyv3edz","updated":"20230817161943"},"Children":[{"ID":"20230817161944-f1d60y6","Type":"NodeParagraph","Properties":{"id":"20230817161944-f1d60y6","updated":"20230817161944"},"Children":[{"Type":"NodeText","Data":"需要查看某一个时间点或者时间段的历史快照信息，比如，查看某一个订单在历史某一个时间点的状态。"}]}]},{"ID":"20230817161945-juoywt0","Type":"NodeListItem","Data":"4","ListData":{"Typ":1,"Tight":true,"Start":4,"Delimiter":46,"Padding":3,"Marker":"NA==","Num":4},"Properties":{"id":"20230817161945-juoywt0","updated":"20230817161945"},"Children":[{"ID":"20230817161946-zcx0vvf","Type":"NodeParagraph","Properties":{"id":"20230817161946-zcx0vvf","updated":"20230817161946"},"Children":[{"Type":"NodeText","Data":"表中的记录变化的比例和频率不是很大，比如，总共有 10 亿的用户，每天新增和发生变化的有 200 万左右，变化的比例占的很小。"}]}]}]},{"ID":"20230817161947-5eqrer4","Type":"NodeParagraph","Properties":{"id":"20230817161947-5eqrer4","updated":"20230817161947"},"Children":[{"Type":"NodeText","Data":"解决方法："},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"通过扩展 start_time、end_time 两个技术字段，来实现每条数据生命周期的管理。"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"start_time 默认为数据进入的时间，end_time 默认为无限大日期 9999-12-31，"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"当数据有变化时，修改历史开链数据的 end_time 为当前时间，将其闭链，然后将新增量的新数据追加到拉链表中。"}]},{"ID":"20230817161948-mhg4is6","Type":"NodeParagraph","Properties":{"id":"20230817161948-mhg4is6","updated":"20230817161948"},"Children":[{"Type":"NodeText","Data":"具体实现："}]},{"ID":"20230817161949-9jkwxii","Type":"NodeParagraph","Properties":{"id":"20230817161949-9jkwxii","updated":"20230817161949"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Ods 层的 User表"}]},{"ID":"20230817161950-rx9jkqr","Type":"NodeParagraph","Properties":{"id":"20230817161950-rx9jkqr","updated":"20230817161950"},"Children":[{"Type":"NodeText","Data":"现在我们来看一下我们 Ods 层的用户资料切片表的结构："}]},{"ID":"20230817161951-ku3v45h","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YXNjcmlwdA==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230817161951-ku3v45h","updated":"20230817161951"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YXNjcmlwdA==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"CREATE EXTERNAL TABLE ods.user (\n  user_num STRING COMMENT '用户编号',\n  mobile STRING COMMENT '手机号码',\n  reg_date STRING COMMENT '注册日期'\nCOMMENT '用户资料表'\nPARTITIONED BY (dt string)\nROW FORMAT DELIMITED FIELDS TERMINATED BY '\\t' LINES TERMINATED BY '\\n'\nSTORED AS ORC\nLOCATION '/ods/user';\n)\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230817161952-8uqch7h","Type":"NodeParagraph","Properties":{"id":"20230817161952-8uqch7h","updated":"20230817161952"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Ods 层的 User_update 表"}]},{"ID":"20230817161953-h7o1kex","Type":"NodeParagraph","Properties":{"id":"20230817161953-h7o1kex","updated":"20230817161953"},"Children":[{"Type":"NodeText","Data":"然后我们还需要一张用户每日更新表，前面已经分析过该如果得到这张表，现在我们假设它已经存在。"}]},{"ID":"20230817161954-trm9bn7","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YXNjcmlwdA==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230817161954-trm9bn7","updated":"20230817161954"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YXNjcmlwdA==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"CREATE EXTERNAL TABLE ods.user_update (\n  user_num STRING COMMENT '用户编号',\n  mobile STRING COMMENT '手机号码',\n  reg_date STRING COMMENT '注册日期'\nCOMMENT '每日用户资料更新表'\nPARTITIONED BY (dt string)\nROW FORMAT DELIMITED FIELDS TERMINATED BY '\\t' LINES TERMINATED BY '\\n'\nSTORED AS ORC\nLOCATION '/ods/user_update';\n)\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230817161955-3aais6t","Type":"NodeParagraph","Properties":{"id":"20230817161955-3aais6t","updated":"20230817161955"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"拉链表"}]},{"ID":"20230817161956-ohxy0uy","Type":"NodeParagraph","Properties":{"id":"20230817161956-ohxy0uy","updated":"20230817161956"},"Children":[{"Type":"NodeText","Data":"现在我们创建一张拉链表："}]},{"ID":"20230817161957-hfloauh","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YXNjcmlwdA==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230817161957-hfloauh","updated":"20230817161957"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YXNjcmlwdA==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"CREATE EXTERNAL TABLE dws.user_his (\n  user_num STRING COMMENT '用户编号',\n  mobile STRING COMMENT '手机号码',\n  reg_date STRING COMMENT '用户编号',\n  t_start_date ,\n  t_end_date\nCOMMENT '用户资料拉链表'\nROW FORMAT DELIMITED FIELDS TERMINATED BY '\\t' LINES TERMINATED BY '\\n'\nSTORED AS ORC\nLOCATION '/dws/user_his';\n)\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230817161958-nvqnn7m","Type":"NodeParagraph","Properties":{"id":"20230817161958-nvqnn7m","updated":"20230817161958"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"实现 Sql 语句"}]},{"ID":"20230817161959-xrw41us","Type":"NodeParagraph","Properties":{"id":"20230817161959-xrw41us","updated":"20230817161959"},"Children":[{"Type":"NodeText","Data":"然后初始化的 Sql 就不写了，其实就相当于是拿一天的 Ods 层用户表过来就行，我们写一下每日的更新语句。"}]},{"ID":"20230817161960-qejagsa","Type":"NodeParagraph","Properties":{"id":"20230817161960-qejagsa","updated":"20230817161960"},"Children":[{"Type":"NodeText","Data":"现在我们假设我们已经已经初始化了 2017-01-01 的日期，然后需要更新 2017-01-02 那一天的数据，我们有了下面的 Sql。"}]},{"ID":"20230817161961-ydu3z99","Type":"NodeParagraph","Properties":{"id":"20230817161961-ydu3z99","updated":"20230817161961"},"Children":[{"Type":"NodeText","Data":"然后把两个日期设置为变量就可以了。"}]},{"ID":"20230817161962-j5dm3ds","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YXNjcmlwdA==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230817161962-j5dm3ds","updated":"20230817161962"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YXNjcmlwdA==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"INSERT OVERWRITE TABLE dws.user_his\nSELECT * FROM\n(\n    SELECT A.user_num,\n           A.mobile,\n           A.reg_date,\n           A.t_start_time,\n           CASE\n                WHEN A.t_end_time = '9999-12-31' AND B.user_num IS NOT NULL THEN '2017-01-01'\n                ELSE A.t_end_time\n           END AS t_end_time\n    FROM dws.user_his AS A\n    LEFT JOIN ods.user_update AS B\n    ON A.user_num = B.user_num\nUNION\n    SELECT C.user_num,\n           C.mobile,\n           C.reg_date,\n           '2017-01-02' AS t_start_time,\n           '9999-12-31' AS t_end_time\n    FROM ods.user_update AS C\n) AS T\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230817161963-5kod7ws","Type":"NodeHeading","HeadingLevel":5,"Properties":{"id":"20230817161963-5kod7ws","updated":"20230817161963"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"##### ","Properties":{"id":""}},{"Type":"NodeText","Data":"查询性能"}]},{"ID":"20230817161964-xly2x2p","Type":"NodeParagraph","Properties":{"id":"20230817161964-xly2x2p","updated":"20230817161964"},"Children":[{"Type":"NodeText","Data":"拉链表当然也会遇到查询性能的问题，比如说我们存放了5年的拉链数据，那么这张表势必会比较大，当查询的时候性能就比较低了，个人认为两个思路来解决："}]},{"ID":"20230817161965-uqfcxjx","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20230817161965-uqfcxjx","updated":"20230817161965"},"Children":[{"ID":"20230817161966-ouilsc7","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20230817161966-ouilsc7","updated":"20230817161966"},"Children":[{"ID":"20230817161967-7vobatx","Type":"NodeParagraph","Properties":{"id":"20230817161967-7vobatx","updated":"20230817161967"},"Children":[{"Type":"NodeText","Data":"在一些查询引擎中，我们对 start_date 和 end_date 做索引，这样能提高不少性能。这种方法其实在 Hive 中行不通，因为 Hive 相当于没有索引，不过在其它系统中可以考虑。"}]}]},{"ID":"20230817161968-jzimgaa","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20230817161968-jzimgaa","updated":"20230817161968"},"Children":[{"ID":"20230817161969-msiheo9","Type":"NodeParagraph","Properties":{"id":"20230817161969-msiheo9","updated":"20230817161969"},"Children":[{"Type":"NodeText","Data":"保留部分历史数据，比如说我们一张表里面存放全量的拉链表数据，然后再对外暴露一张只提供近 3 个月数据的拉链表。"}]}]}]}]}