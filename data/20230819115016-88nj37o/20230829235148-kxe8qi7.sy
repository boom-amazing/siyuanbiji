{"ID":"20230829235148-kxe8qi7","Spec":"1","Type":"NodeDocument","Properties":{"id":"20230829235148-kxe8qi7","scroll":"\u0026#123;\u0026quot;rootId\u0026quot;:\u0026quot;20230829235148-kxe8qi7\u0026quot;,\u0026quot;startId\u0026quot;:\u0026quot;20230830112611-ffpjwxc\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20230902194639-la0alf5\u0026quot;,\u0026quot;scrollTop\u0026quot;:0\u0026#125;","title":"青海ck和zk问题排查","updated":"20230902194838"},"Children":[{"ID":"20230830112611-ffpjwxc","Type":"NodeParagraph","Properties":{"id":"20230830112611-ffpjwxc","updated":"20230902193421"},"Children":[{"Type":"NodeText","Data":"问题背景:"}]},{"ID":"20230902193422-xwqg47y","Type":"NodeParagraph","Properties":{"id":"20230902193422-xwqg47y","updated":"20230902193621"},"Children":[{"Type":"NodeText","Data":"ck大量表被锁，很多表出现read only的问题，导致parquet数据不能入库，并且在这之前主机被频繁的修改了主机名。"}]},{"ID":"20230902194817-t5u123k","Type":"NodeParagraph","Properties":{"id":"20230902194817-t5u123k","updated":"20230902194838"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"width: 95%;","style":"width: 10000px;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"b1cc3321898a4ea5715165340bcbbcc"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/b1cc3321898a4ea5715165340bcbbcc-20230902194817-1t7y889.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"width: 10000px;\" parent-style=\"width: 95%;\"}"},{"Type":"NodeText","Data":"​"}]},{"ID":"20230902193517-tu7p8qi","Type":"NodeParagraph","Properties":{"id":"20230902193517-tu7p8qi","updated":"20230902193527"},"Children":[{"Type":"NodeText","Data":"问题排查过程:"}]},{"ID":"20230902193527-gptd4pw","Type":"NodeParagraph","Properties":{"id":"20230902193527-gptd4pw","updated":"20230902193657"},"Children":[{"Type":"NodeText","Data":"ck出现read only问题 ，根据过往经验，极有可能是zk出现了关联不上的问题。所以首先排查zk的日志是否正常。"}]},{"ID":"20230902193856-l1xa3yr","Type":"NodeParagraph","Properties":{"id":"20230902193856-l1xa3yr","updated":"20230902194105"},"Children":[{"Type":"NodeText","Data":"通过查看zk日志，发现大量的there is not server running的日志，推测由于频繁的更换主机名，导致zk datadir、logdir的快照出现问题。解决方法是删除对应目录下的version以及进程id ，然后重启解决。"}]},{"ID":"20230902194113-nvkwmlr","Type":"NodeParagraph","Properties":{"id":"20230902194113-nvkwmlr","updated":"20230902194259"},"Children":[{"Type":"NodeText","Data":"但是由于删除了zk的version 此时ck虽然能关联上zk了 但是原有ck表的zk path会丢失 依然会出现read only的表，这个时候我们可以手动的修复这些read only 表 。解决方法为"}]},{"ID":"20230902194301-wxsxk7q","Type":"NodeParagraph","Properties":{"id":"20230902194301-wxsxk7q","updated":"20230902194434"},"Children":[{"Type":"NodeText","Data":"查询所有节点状态为read only的 表"}]},{"ID":"20230829235148-iy78so7","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230829235148-iy78so7","updated":"20230902194439"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c3Fs"},{"Type":"NodeCodeBlockCode","Data":"select hostname() AS host,database,table,is_session_expired,is_readonly,future_parts,\nzookeeper_exception,last_queue_update_exception\nFROM clusterAllReplicas('集群名称',system.replicas) WHERE is_readonly ORDER BY host;\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230902194441-olktyx2","Type":"NodeParagraph","Properties":{"id":"20230902194441-olktyx2","updated":"20230902194447"},"Children":[{"Type":"NodeText","Data":"修复方法"}]},{"ID":"20230902194457-bsa4e9m","Type":"NodeParagraph","Properties":{"id":"20230902194457-bsa4e9m","updated":"20230902194508"},"Children":[{"Type":"NodeText","Data":"依次执行以下语句"}]},{"ID":"20230902194447-5rb7gda","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230902194447-5rb7gda","updated":"20230902194455"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c3Fs"},{"Type":"NodeCodeBlockCode","Data":"DETACH TABLE db_name.table_name;\nATTACH TABLE db_name.table_name;\nSYSTEM RESTORE REPLICA db_name.table_name;\nSYSTEM SYNC REPLICA db_name.table_name;\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230902194510-g6gejaj","Type":"NodeParagraph","Properties":{"id":"20230902194510-g6gejaj","updated":"20230902194552"},"Children":[{"Type":"NodeText","Data":"恢复脚本"}]},{"ID":"20230902194552-pu5c4ay","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230902194552-pu5c4ay","updated":"20230902194625"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c2hlbGw="},{"Type":"NodeCodeBlockCode","Data":"#!/bin/bash\n# clickhouse机器的IP和端口\nhosts=(\"192.168.0.110\" \"192.168.0.111\" \"192.168.0.112\")\nports=(\"9000\" \"9002\")\n\nfor host in ${hosts[@]}; do\n    for port in ${ports[@]}; do\n    \tquery_result=$(clickhouse-client -u default --password 123456 --port $port -h $host --query \"select database,table from system.replicas where is_readonly;\")\n    \t# 该节点没有readonly状态的表，直接跳过\n    \tif [ -z \"$query_result\" ]; then\n    \t\techo \"$host:$port not have readonly table,skip\"\n    \t\tcontinue\n    \tfi\n\t\t# 将结果按行分割，并遍历每一行\n\t\twhile IFS= read -r line; do\n\t\t  # 分割行中的字段获取到数据库名和表名，并保存到变量中\n\t\t  database=$(echo $line | cut -d ' ' -f 1)\n\t\t  table=$(echo $line | cut -d ' ' -f 2)\n\t\t  \n\t\t  # 拼接新的SQL语句数组\n\t\t  new_sql=(\"DETACH TABLE $database.$table;\" \"ATTACH TABLE $database.$table;\" \"SYSTEM RESTORE REPLICA $database.$table;\" \"SYSTEM SYNC REPLICA $database.$table;\")\n\t\t  \n\t\t  # 循环执行新的SQL语句并输出结果\n\t\t  for sql in \"${new_sql[@]}\"; do\n\t\t    # 执行新的SQL语句并输出结果\n\t\t    echo \"Results for $database.$table:\"\n\t\t    clickhouse-client -u default --password 123456 --port $port -h $host --query \"$sql\"\n\t\t    echo \"\"\n\t\t  done\n\t\tdone \u003c\u003c\u003c \"$query_result\"\n\tdone\ndone\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230902194623-pxucjx1","Type":"NodeParagraph","Properties":{"id":"20230902194623-pxucjx1","updated":"20230902194633"},"Children":[{"Type":"NodeText","Data":"给脚本授权"}]},{"ID":"20230902194633-nw5ltog","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230902194633-nw5ltog","updated":"20230902194641"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c2hlbGw="},{"Type":"NodeCodeBlockCode","Data":"chmod 755 restore_readonly.sh\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230902194639-la0alf5","Type":"NodeParagraph","Properties":{"id":"20230902194639-la0alf5"}}]}